---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { TrainingPlanView } from "@/components/dashboard/TrainingPlanView";
import EmptyState from "@/components/EmptyState";
import type { TrainingPlanWithWorkoutsDTO } from "@/types";
import type { ApiSuccessResponse } from "@/types";

// Disable prerendering for SSR
export const prerender = false;

// User is guaranteed to be authenticated here (middleware redirects if not)

// Fetch active training plan server-side
const response = await fetch(`${Astro.url.origin}/api/training-plans/active`, {
  headers: {
    Cookie: Astro.request.headers.get("Cookie") || "",
  },
});

let trainingPlan: TrainingPlanWithWorkoutsDTO | null = null;

if (response.ok) {
  const data = (await response.json()) as ApiSuccessResponse<TrainingPlanWithWorkoutsDTO>;
  trainingPlan = data.data;
} else if (response.status === 404) {
  // No active plan - will show EmptyState
  trainingPlan = null;
} else {
  // 500 or other error - for now pass null, later can add error page
  console.error("Failed to fetch training plan:", response.status);
  trainingPlan = null;
}
---

<DashboardLayout title="Dashboard - TwÃ³j plan treningowy">
  {
    trainingPlan ? (
      <TrainingPlanView client:load trainingPlan={trainingPlan} />
    ) : (
      <EmptyState client:load variant="no-plan" />
    )
  }
</DashboardLayout>
