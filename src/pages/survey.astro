---
import Layout from "@/layouts/Layout.astro";
import { SurveyForm } from "@/components/survey/SurveyForm";
import { createSupabaseServerInstance } from "@/db/supabase.client.ts";
import type { ProfileDTO, PersonalRecordDTO } from "@/types";

// Disable prerendering for SSR
export const prerender = false;

// User is guaranteed to be authenticated here (middleware redirects if not)
const user = Astro.locals.user!;

// Create Supabase client for data fetching
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: Astro.request.headers,
});

// Fetch user profile (optional for pre-fill)
let initialProfile: ProfileDTO | null = null;
try {
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if (profileError) {
    if (profileError.code !== "PGRST116") {
      // Not "no rows returned" error
      console.error("Error fetching profile:", profileError);
    }
  } else {
    initialProfile = profile;
  }
} catch (error) {
  console.error("Unexpected error fetching profile:", error);
}

// Fetch personal records (optional for pre-fill)
let initialPersonalRecords: PersonalRecordDTO[] = [];
try {
  const { data: records, error: recordsError } = await supabase
    .from("personal_records")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: true });

  if (recordsError) {
    console.error("Error fetching personal records:", recordsError);
  } else if (records) {
    initialPersonalRecords = records;
  }
} catch (error) {
  console.error("Unexpected error fetching personal records:", error);
}
---

<Layout
  title="Ankieta - Athletica"
  description="Wypełnij ankietę, aby wygenerować spersonalizowany plan treningowy biegowy"
>
  <main class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      {/* Header */}
      <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight mb-2">Ankieta treningowa</h1>
        <p class="text-muted-foreground text-lg">
          Wypełnij poniższy formularz, aby wygenerować spersonalizowany 10-tygodniowy plan treningowy dopasowany do
          Twoich celów i możliwości.
        </p>
      </div>

      {/* Survey Form */}
      <SurveyForm client:load initialProfile={initialProfile} initialPersonalRecords={initialPersonalRecords} />
    </div>
  </main>
</Layout>
